# Audit du 10/12/2025 - Factorisation des données et réduction de la taille des fichiers

## Constat global

- L'application est une SPA front (HTML + CSS + JS modules) sans backend PHP.
- Fichiers principaux :
  - `index.html` : structure de la page + longue liste de sections (`.paragraph-card`).
  - `assets/js/main_core.js` : cœur de la logique + beaucoup de données statiques (types de prompts, templates, analyse locale, stockage local).
  - `assets/js/main_prompts.js` : gestion des prompts nommés, favoris, import/export.
  - `assets/js/main_ab.js` : overlay de comparaison A/B.
  - `assets/js/main_v2.js` : point d'entrée qui connecte les modules.
  - `assets/js/app.js` : ancien script redondant/non utilisé (supprimé).
  - `assets/css/style.css` : styles, long mais essentiellement déclaratif.

## Zones volumineuses ou très denses

- `assets/js/main_core.js` (~1000+ lignes, ~43 Ko)

  - Contient :
    - **Données de configuration** :
      - `PROMPT_TYPES` (types de prompts, sections recommandées/visibles).
      - `TEMPLATES` (grand objet de templates avec textes longs de presets).
    - **Logique UI** :
      - Gestion des cartes (`cards`), rendu DOM, boutons, indicateurs.
      - Gestion du sélecteur de type de prompt, badges recommandés, etc.
    - **Persistance locale** :
      - `STORAGE_KEY`, `loadStorage`, `saveStorage`, `saveLastSession`.
    - **Analyse locale** :
      - `updateAnalysis`, `computeLocalAnalysis`, etc.

- `index.html`

  - Longue liste de blocs `.paragraph-card` (sections Persona, Goal, Context, etc.).
  - Ces blocs sont essentiellement des **données métier** codées en HTML :
    - identifiant logique : `data-paragraph="Persona"`, `Goal`, `Context`, etc.
    - titre affiché : `<h3>Persona</h3>` ...
    - texte descriptif : `<p>...</p>`
    - `title` (tooltip) avec un exemple.

- `assets/js/app.js`
  - Logique ancienne de gestion de cartes et du prompt (doublon avec `main_core.js`).
  - Pas utilisé dans `index.html` (le script chargé est `main_v2.js`).

## Blocs de données statiques identifiés

- [x] **PROMPT_TYPES dans `main_core.js`**

  - Objet qui définit les types de prompts :
    - `general`, `music`, `image`, `persona`, ...
  - Pour chaque type :
    - `label` (libellé affiché),
    - `recommendedSections` (sections à privilégier),
    - `visibleSections` (sections visibles dans la colonne de gauche).
  - C'est de la configuration métier pure, sans logique.

- [x] **TEMPLATES dans `main_core.js`**

  - Gros objet littéral qui regroupe de nombreux templates prédéfinis :
    - `simple-question`, `text-analysis`, `code-generation`, `agent-tool`,
      `critic-harsh`, `critic-kind`, `devils-advocate`,
      `tutor-socratic`, `coach-beginner`,
      `constraints-checker`, `clarity-reviewer`,
      `bono-white-hat`, `bono-red-hat`, `bono-black-hat`, `bono-yellow-hat`, `bono-green-hat`, `bono-blue-hat`, etc.
  - Chaque template contient :
    - `displayName`,
    - `sections` (liste des types de cartes à utiliser),
    - `presets` (textes longs préremplis par section : `Persona`, `Goal`, `Context`, ...).
  - C'est la source principale de la **taille importante** de `main_core.js`.

- [x] **Listes de sections dans `index.html` (`.paragraph-card`)**

  - Pour chaque section logique (Persona, Goal, Context, Audience, etc.) :
    - `data-paragraph` (identifiant logique utilisé par le JS),
    - titre (`<h3>`),
    - description (`<p>`),
    - texte d'exemple via l'attribut `title`.
  - Ces blocs pourraient être générés à partir d'une structure de données centralisée.

- [ ] **Redondances autour de `TEMPLATES`**
  - `main_prompts.js` et `main_ab.js` utilisent `coreModule.TEMPLATES` pour :
    - remplir le `<select id="saved-prompts-select">` (groupe "Modèles"),
    - alimenter la liste des templates dans l'overlay A/B.
  - Toute modification de templates implique plusieurs fichiers.

## Pistes de factorisation et de réduction de taille

### A. Extraire les données de prompts (PROMPT_TYPES + TEMPLATES) dans un module dédié

- [x] **Créer un module JS de données** (approche privilégiée dans un premier temps)

  - Créer `assets/js/prompt_data.js` qui exporte :
    - `PROMPT_TYPES`,
    - `TEMPLATES`.
  - Adapter `main_core.js` :
    - supprimer les définitions inline de `PROMPT_TYPES` et `TEMPLATES`,
    - importer ces constantes depuis `prompt_data.js`.
  - Adapter si nécessaire `main_prompts.js` / `main_ab.js` pour utiliser la même source de vérité (via `coreModule.TEMPLATES` ou import direct).

- [ ] **Alternative JSON/XML**
  - Variante possible :
    - `assets/js/prompt_types.json` et `assets/js/templates.json`,
    - chargement via `fetch()` au démarrage, puis initialisation des constantes.
  - Avantages : données complètement découplées du code, éditables sans JS.
  - Inconvénients : gestion de l'asynchrone (chargement avant usage), complexité supplémentaire pour une simple SPA statique.

### B. Générer dynamiquement les `.paragraph-card` depuis des données

- [x] **Centraliser la définition des sections**

  - Créer une structure de données (ex. dans un module `section_definitions.js` ou dans `prompt_data.js`) qui décrit :
    - l'identifiant (`id` / `key`),
    - le titre affiché,
    - le texte descriptif,
    - l'exemple pour le tooltip,
    - éventuellement l'icône.

- [x] **Générer le HTML côté JS**

  - Dans `index.html` :
    - remplacer la longue liste de `.paragraph-card` par un conteneur vide :
      - `<div class="paragraph-cards"></div>`.
  - Au démarrage (dans `initializeCoreModule` ou un module dédié UI) :
    - itérer sur la liste des sections,
    - créer dynamiquement les `.paragraph-card` dans le DOM.

- [x] **Bénéfices**
  - Réduction de la taille de `index.html` (moins de duplication textuelle).
  - Ajout ou modification de sections à un seul endroit.
  - Alignement plus facile entre :
    - les sections affichées,
    - `PROMPT_TYPES.visibleSections`,
    - `TEMPLATES.sections`.

### C. Nettoyage et simplification des scripts

- [x] **Gérer `assets/js/app.js` (script legacy)**

  - Vérifier s'il est encore utilisé (actuellement non référencé dans `index.html`).
  - Options :
    - le supprimer (si complètement obsolète),
    - ou le déplacer dans un dossier `legacy/` pour archivage.

- [x] **Découper `main_core.js` en plusieurs modules** (éventuellement dans un second temps)
  - Exemple de séparation :
    - `core_data.js` : constantes, données de configuration déjà extraites.
    - `core_ui.js` : gestion des cartes, DOM, boutons, copy, etc.
    - `core_storage.js` : localStorage (load/save, `lastSession`, `prompts`, `versions`).
    - `core_analysis.js` : score de complétude, recommandations, affichage.
  - `main_v2.js` reste le point d'entrée qui orchestre l'initialisation.

### D. Optimisations CSS secondaires (optionnelles)

- [ ] **Factoriser certains styles répétés**
  - Plusieurs règles autour des boutons, sélecteurs et grilles pourraient être factorisées.
  - Gain surtout en lisibilité, pas critique avant la factorisation des données.

## Priorisation proposée

1. [x] **Extraction des données de prompts (`PROMPT_TYPES` + `TEMPLATES`) dans un module dédié**

   - Gros impact sur la taille et la lisibilité de `main_core.js`.
   - Centralisation des données métier.

2. [x] **Nettoyage de `app.js` (suppression/déplacement)**

   - Réduit le bruit dans `assets/js`.

3. [x] **Génération dynamique des `.paragraph-card`**

   - Allège `index.html` et centralise la définition des sections.

4. [x] **Découpage de `main_core.js` en sous-modules (UI, stockage, analyse)**
   - Améliore encore la maintenabilité.

---

Ce fichier pourra être utilisé comme checklist lors des prochains refactors, en cochant chaque tâche au fur et à mesure de leur réalisation.
